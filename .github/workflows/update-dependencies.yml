# .github/workflows/update-dependencies.yml

name: Update Dependencies

on:
  # Runs on a schedule (every Monday at 05:30 UTC)
  schedule:
    - cron: '30 5 * * 1'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    # These permissions are required for the action to create a pull request
    permissions:
      contents: write
      pull-requests: write

    steps:
    # Step 1: Check out the repository's code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Step 2: Set up Node.js
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    # Step 3: Update dependencies and fix vulnerabilities
    - name: Update packages and fix vulnerabilities
      run: |
        # Ensure webpack-cli is in package.json, adding it if not
        # Note: It's best practice to run 'npm install webpack-cli --save-dev' locally and commit it once
        if ! grep -q 'webpack-cli' package.json; then
          npm install --save-dev webpack-cli
        fi
        
        # Install dependencies from lock file
        npm ci
        
        # Update packages based on package.json semantic versioning
        npm update
        
        # Attempt to fix any security vulnerabilities
        npm audit fix --force
        
        # One final install to clean up the lock file
        npm install

    # Step 4: Create a pull request if changes were made
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        # Configuration for the pull request
        commit-message: "chore: Update npm dependencies and fix vulnerabilities"
        title: "ðŸ¤– Automated Dependency Update"
        body: |
          This PR was auto-generated by a GitHub Action.
          
          - Updates `npm` dependencies to their latest versions based on `package.json`.
          - Includes security fixes from `npm audit fix`.
          
          Please review and merge.
        branch: "automated-dependency-updates"
        delete-branch: true
        labels: "dependencies, automated pr"
